[appendix,obligation="informative"]
== Notes for deformation model producers

[[discuss-elements]]
=== Decomposition into elements

This deformation model specification assumes that the deformation can be partitioned into one or more elements each of which is characterized by a time function.  There are many other ways deformation can be modelled.  For example in geophysical research it is often modelled using uniform dislocation on a rectangular fault surfaces in a uniform elastic half space.  While such models may be used to research and develop deformation models, the common practice in publishing them for coordinate transformtions is to convert the model to a grid describing the resultant surface displacement.  

Deformation is caused by a number of geophysical phenomena, each of which may be represented by one or more elements in a deformation model.  

Typically, there is a secular velocity element representing the long term tectonic deformation - this is a single element with a velocity time function.  

Overlaid on this there may be deformation due to earthquakes.  The coseismic deformation will be represented by an element with a step time function.  Postseismic deformation from the earthquake may be represented by several elements depending on the complexity of the deformation and the quality of information about it.  Several versions of a deformation model may be published after an earthquake as the ongoing postseismic deformation evolves and as the measurements and modeling of deformation are refined.

Alternatively, the deformation model may be based more directly on observations.  For example, in Japan the dense network of CORS stations provides a continuous record of deformation.  Each year a new version of the deformation model is generated based on these measurements. Each of these could be represented by an element with a step time function.


[[discuss-continuous-invertible]]
=== Requirement for the model to be continuous and invertible

Deformation models described by this specification are used for coordinate operations - either to define time dependent transformations between different coordinate systems or to track the motion of objects between different epochs within a single coordinate system.  

Generally, the user expectation of these functions is that they are invertible.  That is, data can be transformed between any two epochs, and transforming data from one epoch to another and then back again leaves it unchanged.  

To support this expectation the deformation model should be spatially continuous and invertible for any valid epoch.  This is specified above as a compliance requirement of a deformation model. 

Within a single grid the use of bilinear interpolation ensures that the deformation is spatially continuous.  It also ensures the deformation is invertible provided the deformation is not greater than the grid spacing, which is generally very unlikely.

The only opportunity for discontinuity in a deformation model is at the edges of grids.

This places two constraints on deformation model producers. 

* where an element does not cover the full extent of the deformation model then the deformation at the edge of the element must be zero.  For example, an element might represent coseismic deformation from an earthquake.  The deformation caused by the earthquake may not be significant over the full extent of the model so the element would only cover a subset of that area.  To ensure continuity the displacements at the edge element should be set to zero, even though the actual displacements will be slightly different from zero. 

* where an element is represented by multiple overlapping or nested grids there will be transitions between one preferred grid and another.  At these transitions the values interpolated from each grid must be exactly the same.  For example, the displacement at the edge of a child grid will generally have exactly match that of its parent grid.  However if the edge abuts the edge of another child grid, then its displacement only needs to match that of the abutting grid.

In practice the second of these constraints means that parent and child grids must be aligned - any node of a parent grid that lies within the child grid must also be a node of the child grid.  Where grids are abutting, then along the common edge at least one of the grids should include all the nodes of the other.

These constraints, and indeed the use of a gridded model, mean that the model cannot represent the true deformation exactly. For example, where there is surface faulting the actual deformation may not be continuous across a fault line. The deformation also may not be invertible (at least as a function of horizontal position) in areas of thrust faulting where points originally on opposite sides of the fault may be moved to the same horizontal position (though at different heights).

For model producers, this can create a tension between the scientific desire to represent deformation as accurately as possible, and the practical constraints of a deformation model suitable for coordinate operations.  This specification is framed within the context of coordinate operations - it is not purporting to model deformation for scientific use.

The challenge for model producers is to decide the extent to which the deformation can be usefully modeled to best support the geospatial community.


// Where an element only covers a portion of the total area of a deformation model the element is assumed to have zero displacement beyond its extent. This is common in deformation elements that include earthquake deformation. In the vicinity of the epicenter there may be extensive deformation. However, there may also be large regions within the extent of the deformation model where the deformation is zero or insignificant. The element representing this only needs to include the area where there is significant deformation. This is shown in <<image-patch-extent>>. In this figure the outer white box defines the total extent of the deformation model. Beyond this the deformation is undefined. The nested grid inside the model represents deformation due to an earthquake. In the region outside the nested grid the deformation from this element is zero.

// [[image-patch-extent]]
// image::patch_extents.png[title=A "patch" element covering a subset of the total model extent, width=400,scalewidth=9cm]

[[discuss-no-data]]
=== No data and zero values

There may be areas within the extent of the deformation model grids where the deformation is either not known or is not within the model producer's jurisdiction.  In these areas the model producer may prefer to not specify an unreliable or unauthoritative displacement.

Grids must be defined by rectangular regions, which are unlikely to match the extent of the known deformation. To avoid grids being used in areas where the deformation is undefined, it is desirable that special “no-data” values can be used for displacements at nodes where this applies.  The implementation of “no-data” will be dictated by the format used to carry the deformation model.

The “no data” value for a displacement is different from a zero displacement. A value of zero is used where there is no significant displacement. A “no-data” value is used where the displacement is unknown.

Instead of using "no data" values, a producer may choose to specify a value with a large uncertainty.  This may be preferable to ensure a continuous and invertible model, as discussed in <<discuss-continuous-invertible>>.  However not all software will use uncertainty information.

If any element of the model evaluates to "no-data" at a given location and time then the displacement (or uncertainty) at that location is undefined. <<image-no-data>> illustrates the use of “no-data” values in the model. In this figure the gray area shows the region where displacement is undefined and the square marks the total extent of the model. Outside this area the model cannot be evaluated. Within the gridded spatial function there are a number of nodes at which the displacement is not defined - these are identified with a “no-data” value. Where these nodes are required to interpolate a displacement, which is any grid cell they are on the boundary of, the displacement cannot be calculated..

[[image-no-data]]
image::no_data.png[title=Influence of "no data" values, width=400,scalewidth=9cm]

The gray area, where displacement is undefined, might include coastal regions where the deformation of the seabed is not measured, or it may cross a jurisdictional boundary. Since the grid is rectangular, it may include regions where the deformation is not known, which are represented in the model by a “no data” value.



[[discuss-geoentric-interpolation]]
=== Deformation models near poles

Special consideration may be required for deformation models using geographic coordinates near the poles.  This specification provides some support for this situation.  However, if possible it is simpler to use a projection coordinate system in polar regions.

Where the interpolation coordinate system is geographic, then <<formula-geocentric-bilinear-interpolation, geocentric bilinear interpolation>> may be required for interpolating horizontal displacements across a grid cell.  This is only required if the grid cells span a large longitude range.  For example, if the grid cell spans 1° of longitude and the displacement is 1m then conventional bilinear interpolation may give rise to an error of up to about 2cm (the length of the displacement vector multiplied by the cosine of the longitude range of the grid cell).  If this is an issue it may still be preferable to define a denser grid and use conventional bilinear interpolation.  

Where the source and target coordinate systems are geographic, then <<formula-displacement-geocentric-addition, geocentric displacement addition>>  is needed to correctly apply a calculated displacement to a coordinate near the pole.  Note that this only applies very close to the pole.  

This is illustrated in <<image-near-pole-east-displacement>> where the gray vector shows the result of adding an east displacement to the longitude coordinate, and the black vector shows the result applying the same east displacement in the direction of the east vector component. Close to the pole, offsetting the longitude coordinate can give a significantly different result to applying a displacement in the direction of the east vector.  At the pole itself, offsetting the longitude coordinate makes no difference to the location at all, and the geocentric displacement addition method must be used.

[[image-near-pole-east-displacement]]
image::near_pole_east_displacement.png[title="Comparison of vector and angular displacement near a pole",width=200,scalewidth=7cm,align="right"]

Moving away from the pole this discrepancy becomes less significant. For a point at distance R from the pole with a displacement d, the difference is approximately d*(1-cos(d/R)), or approximately d^3^/2R^2^. For example, applying 1 m east displacement 1 km from the pole by offsetting the longitude would incur an error of only 5.10^-7^m.

If the deformation model doesn't include the pole itself then this method is not recommended as it is significantly more computationally intensive.


////
The geocentric weighted average method proposed in <<formula-geocentric-bilinear-interpolation>> is intended for use in near polar regions where east and north topocentric vectors at adjacent grid nodes differ significantly in orientation.


[[image-geocentric-bilinear-interpolation]]
image::geocentric_bilinear_interpolation.png[title=geocentric bilinear interpolation diagram, width=200,scalewidth=7cm]

To estimate the error that could be incurred using simple bilinear interpolation and not accounting for this directional difference, consider a case where the displacement is 1 meter northwards at point A in <<image-geocentric-bilinear-interpolation>>, and zero meters at point B. Let the longitude grid spacing be λ~s~ radians. If the calculation point P is λ radians past A, then the magnitude of the interpolated displacement will be (λ~s~-λ)/λ~s~. The error of orientation will be λ radians (the difference between north at A and north at the calculation point) and the displacement error will be sin(λ).(λ~s~-λ)/λ~s~. Approximating sin(λ) as λ, the error has a maximum absolute value in the range (0,λ~s~) of λ~s~/2. For example, with a grid longitude spacing of 1° the displacement error is about 2cm.


Using the geocentric interpolation method to calculate the horizontal component does cause some “leakage” of the horizontal deformation into the vertical component, that is:

du = dx.cos(λ).cos(φ) + dy.sin(λ).cos(φ) + dz.sin(φ)

For the interpolation of vertical displacement du this method proposes using the same formulae as the bilinear interpolation method - that is simple bilinear interpolation of the du component.  However this leakage does result in a small loss of magnitude in the horizontal component. The reduction is approximately scaling by the cosine of the angle between the vertical at the calculation point and the vertical at each grid node.  For a grid cell of 1 degree extent this would result in a scale error of 0.2mm for a 1m deformation vector.  (Note that this is a 1 degree extent measured on the globe - not a 1 degree extent of longitude which may be much smaller near the poles).  This can be ignored without significant loss of accuracy.


////



[[discuss-time-function-epochs]]
=== Time function epochs

The time functions used for deformation model elements can be modified by specifying a function reference epoch t~0~, a start epoch t~s~, and an end epoch t~e~.  The effect of these is illustrated in <<image-hyperbolic-epoch-modification>> showing a hyperbolic tangent function without these parameters and the same function with all three parameters applied.  In both cases the function has an event epoch t~v~ = 2013.8 and a time constant &#964; = 0.8 years.  

[[image-hyperbolic-epoch-modification]]
image::hyperbolic_epoch_modification.png[title="The effect of adding a start and end epoch (t~s~, t~e~) and a function reference epoch (t~0~) to a time function"]

The unmodified function shows an event building in magnitude from 0.0 to 1.0.  This might represent, for example, a slow slip event.  The mathematical definition of this function is never quite 0 or 1 - it approaches 0 exponentially as the epoch moves further into the past and approaches 1 asymptotically as the epoch moves further into the future.  The rate of change becomes infinitesimally small more than a few years from the event date. From the point of view of deformation model producer managing a coordinate system, it is may be more practical to define start and end epochs for the event, t~s~ and t~e~ s such that the change before t~s~, and after t~e~, is actually zero.  This may also be more realistic geophysically.

The function reference epoch t~0~ is an epoch at which the function will be zero, and therefore when the calculated displacement for the event will be zero.  A constant offset is added to the function to force it to be zero before this epoch.  A common usage for function reference epoch is to include deformation model that occurred before the reference epoch of a datum. 

